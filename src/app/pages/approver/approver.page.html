<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Approver Dashboard</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Approver Dashboard</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="ion-padding">
    <!-- Segment selector for switching views -->
    <ion-segment [(ngModel)]="segmentValue" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="pendingRequests">
        <ion-label>Pending Requests</ion-label>
      </ion-segment-button>
      <ion-segment-button value="addItem">
        <ion-label>Add New Item</ion-label>
      </ion-segment-button>
      <ion-segment-button value="manageItems">
        <ion-label>Manage Items</ion-label>
      </ion-segment-button>
    </ion-segment>

    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="ion-text-center ion-padding">
      <ion-spinner name="circles"></ion-spinner>
      <p>Loading data...</p>
    </div>

    <!-- Pending Requests View -->
    <div *ngIf="segmentValue === 'pendingRequests' && !isLoading">
      <h2>Pending Approval Requests</h2>
      
      <ion-list *ngIf="pendingRequests.length > 0">
        <ion-item *ngFor="let request of pendingRequests">
          <ion-card class="ion-margin-vertical" style="width: 100%">
            <ion-card-header>
              <ion-card-subtitle>Request #{{ request.id }}</ion-card-subtitle>
              <ion-card-title>{{ request.itemName }}</ion-card-title>
            </ion-card-header>
            
            <ion-card-content>
              <ion-grid>
                <ion-row>
                  <ion-col size="6">
                    <p><strong>Requested by:</strong> {{ request.requesterName }}</p>
                    <p><strong>Email:</strong> {{ request.requesterEmail }}</p>
                    <p><strong>Purpose:</strong> {{ request.purpose || request.reason }}</p>
                    <p><strong>Department:</strong> {{ request.department }}</p>
                  </ion-col>
                  <ion-col size="6">
                    <p><strong>Requested:</strong> {{ formatDate(request.requestDate) }}</p>
                    <p><strong>Return by:</strong> {{ formatDate(request.returnDate) }}</p>
                    <p><strong>Item Code:</strong> {{ request.itemCode || request.itemId }}</p>
                    <p><strong>Status:</strong> 
                      <ion-badge color="warning">{{ request.status }}</ion-badge>
                    </p>
                  </ion-col>
                </ion-row>
                
                <ion-row class="ion-margin-top">
                  <ion-col>
                    <ion-button expand="block" color="success" (click)="approveRequest(request)">
                      <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                      Approve
                    </ion-button>
                  </ion-col>
                  <ion-col>
                    <ion-button expand="block" color="danger" (click)="rejectRequest(request)">
                      <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                      Reject
                    </ion-button>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ion-item>
      </ion-list>
      
      <div *ngIf="pendingRequests.length === 0" class="ion-text-center ion-padding">
        <ion-icon name="checkmark-circle" color="success" style="font-size: 48px;"></ion-icon>
        <h3>No pending requests</h3>
        <p>All borrow requests have been processed.</p>
      </div>
    </div>

    <!-- Add Item View -->
    <div *ngIf="segmentValue === 'addItem' && !isLoading">
      <h2>Add New Item</h2>
      
      <form [formGroup]="itemForm" (ngSubmit)="submitItemForm()">
        <ion-item>
          <ion-label position="stacked">Item Name</ion-label>
          <ion-input formControlName="name" type="text" placeholder="Enter item name"></ion-input>
          <ion-note slot="error" *ngIf="itemForm.get('name')?.invalid && itemForm.get('name')?.touched">
            Name is required
          </ion-note>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Description</ion-label>
          <ion-textarea formControlName="description" rows="3" placeholder="Enter item description"></ion-textarea>
          <ion-note slot="error" *ngIf="itemForm.get('description')?.invalid && itemForm.get('description')?.touched">
            Description is required
          </ion-note>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Department</ion-label>
          <ion-select formControlName="department" placeholder="Select department">
            <ion-select-option value="IMC">IMC</ion-select-option>
            <ion-select-option value="SCS">SCS</ion-select-option>
            <ion-select-option value="PAO">PAO</ion-select-option>
          </ion-select>
          <ion-note slot="error" *ngIf="itemForm.get('department')?.invalid && itemForm.get('department')?.touched">
            Department is required
          </ion-note>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Product Code</ion-label>
          <ion-input formControlName="productCode" type="text" placeholder="Enter product code"></ion-input>
          <ion-note slot="error" *ngIf="itemForm.get('productCode')?.invalid && itemForm.get('productCode')?.touched">
            Product code is required
          </ion-note>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Status</ion-label>
          <ion-select formControlName="status" placeholder="Select status">
            <ion-select-option value="available">Available</ion-select-option>
            <ion-select-option value="in_use">In Use</ion-select-option>
            <ion-select-option value="maintenance">Maintenance</ion-select-option>
            <ion-select-option value="reserved">Reserved</ion-select-option>
          </ion-select>
          <ion-note slot="error" *ngIf="itemForm.get('status')?.invalid && itemForm.get('status')?.touched">
            Status is required
          </ion-note>
        </ion-item>
        
        <div class="ion-padding">
          <ion-label>Item Image</ion-label>
          <input type="file" accept="image/*" (change)="onImageSelected($event)" class="ion-margin-top">
        </div>
        
        <!-- Image preview -->
        <div *ngIf="previewImage" class="ion-padding">
          <h4>Image Preview</h4>
          <img [src]="previewImage" style="max-width: 100%; max-height: 200px;">
        </div>
        
        <div class="ion-padding">
          <ion-button expand="block" type="submit" [disabled]="!itemForm.valid || isSubmitting">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Add Item
          </ion-button>
        </div>
      </form>
    </div>

    <!-- Manage Items View -->
    <div *ngIf="segmentValue === 'manageItems' && !isLoading">
      <h2>Manage Existing Items</h2>
      
      <ion-searchbar placeholder="Search items" (ionChange)="searchItems($event)" animated></ion-searchbar>
      
      <ion-list *ngIf="filteredItems.length > 0">
        <ion-item-sliding *ngFor="let item of filteredItems">
          <ion-item>
            <ion-thumbnail slot="start">
              <img [src]="item.image || 'assets/items/default-item.png'" alt="{{ item.name }}">
            </ion-thumbnail>
            <ion-label>
              <h2>{{ item.name }}</h2>
              <p>{{ item.description }}</p>
              <p>
                <ion-badge [color]="
                  item.status === 'available' ? 'success' : 
                  item.status === 'borrowed' ? 'warning' : 
                  item.status === 'maintenance' ? 'danger' : 'medium'">
                  {{ item.status }}
                </ion-badge>
                <ion-badge color="primary" class="ion-margin-start">{{ item.department }}</ion-badge>
              </p>
              <p class="ion-text-muted">Code: {{ item.productCode }}</p>
            </ion-label>
          </ion-item>
          
          <ion-item-options side="end">
            <ion-item-option color="primary" (click)="editItem(item)">
              <ion-icon slot="icon-only" name="create-outline"></ion-icon>
            </ion-item-option>
            <ion-item-option color="danger" (click)="deleteItem(item)">
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-item-option>
          </ion-item-options>
        </ion-item-sliding>
      </ion-list>
      
      <div *ngIf="filteredItems.length === 0" class="ion-text-center ion-padding">
        <ion-icon name="alert-circle" color="medium" style="font-size: 48px;"></ion-icon>
        <h3>No items found</h3>
        <p>No items match your search criteria or no items have been added yet.</p>
      </div>
    </div>
  </div>
</ion-content>
